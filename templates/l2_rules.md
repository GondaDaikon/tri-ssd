---
id: RULES-YYYYMMDD-001
kind: rules
layer: L2
status: active
doc_status: draft
---
<!-- 注: 実際の使用時は /draft-rules がIDを自動採番します -->

<!--
  テンプレート使用ガイド:

  【最小限で始める】
  - 初期生成時は各セクション2〜3項目程度で十分
  - L3実装を通じて必要なルールを追加していく
  - 「あらゆるケースを事前に想定」しない

  【必須セクション】
  - 1.1 言語・フレームワーク
  - 1.2 命名規則（主要なもののみ）
  - 7. AI固有の禁止事項

  【省略可能セクション】
  - 1.4 禁止事項（問題が発生してから追加でよい）
  - 2. アーキテクチャ詳細（シンプルな構成なら省略可）
  - 3. ドメインルール（L1から自明なら省略可）
  - 5. セキュリティ・ログ（foundation.mdで記述済みなら簡略化）
  - 6. テスト（シンプルなプロジェクトなら最小限でよい）

  【ルール追加の基準】
  - 再発可能性がある
  - セキュリティ・データ破損に関わる
  - ルールとして一般化できる
  - 上記に該当しなければ、当該L3への注記にとどめる
-->

# 実装ルール

> 本ドキュメントはAI/人がコード実装時に守るべきルールを定義する。
> `/draft-rules` で初期版（たたき台）を生成し、L3実装を通じて進化させる。

---

## 1. コード規約

### 1.1 言語・フレームワーク

- 言語: [例: TypeScript 5.x]
- フレームワーク: [例: React 18, Next.js 14]
- ランタイム: [例: Node.js 20]

### 1.2 命名規則

| 対象 | 規則 | 例 |
|------|------|-----|
| ファイル名 | [例: kebab-case] | `user-service.ts` |
| フォルダ名 | [例: kebab-case] | `user-management/` |
| クラス名 | [例: PascalCase] | `UserService` |
| 関数名 | [例: camelCase] | `getUserById` |
| 変数名 | [例: camelCase] | `userName` |
| 定数名 | [例: UPPER_SNAKE_CASE] | `MAX_RETRY_COUNT` |
| DBテーブル名 | [例: snake_case] | `user_accounts` |
| APIエンドポイント | [例: kebab-case] | `/api/v1/user-accounts` |

### 1.3 ディレクトリ構成

```
src/
  [構成を記載]
```

### 1.4 禁止事項

- [例: any型の使用禁止]
- [例: console.logの本番コード残存禁止]
- [例: マジックナンバーの直接記述禁止]

---

## 2. アーキテクチャ

### 2.1 レイヤー構成

```
[例]
Controller（API層）
    ↓
Service（ビジネスロジック層）
    ↓
Repository（データアクセス層）
    ↓
Database
```

### 2.2 依存方向

**許可:**
- [例: Controller → Service → Repository]

**禁止:**
- [例: Controller → Repository 直接呼び出し]
- [例: Service → Controller への逆依存]
- [例: Repository → Service への逆依存]

### 2.3 トランザクション境界

- [例: Service層で管理]
- [例: 複数Repository呼び出しはService内でトランザクション制御]

### 2.4 状態管理

- [例: クライアント状態はZustandで管理]
- [例: サーバー状態はTanStack Queryで管理]
- [例: グローバルステートは最小限に]

---

## 3. ドメインルール

> L1から抽出、またはL3実装で発見したビジネスルール。
> 絶対に壊してはいけない制約を記載する。

- [例: 過去日時の予約は不可]
- [例: 同一ユーザーの同一時間帯二重予約は不可]
- [例: 課金処理は必ずPaymentServiceを経由する]
- [例: ユーザー削除時は関連データを論理削除]

**参照元**: L1 `docs/l1_vision.md`

---

## 4. API・データアクセス

### 4.1 API規約

- [例: RESTful原則に従う]
- [例: エンドポイントは複数形名詞 `/users`, `/tasks`]
- [例: エラーレスポンスは共通フォーマット]

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "人間向けメッセージ"
  }
}
```

### 4.2 データアクセス

- [例: N+1クエリ禁止]
- [例: 一覧取得は必ずページング（デフォルト20件、最大100件）]
- [例: 生SQL禁止、ORM使用必須（例外は要相談）]
- [例: SELECT * 禁止、必要なカラムのみ取得]

---

## 5. セキュリティ・ログ

### 5.1 認証・認可

- [例: user_idはJWTトークンから取得、リクエストボディを信用しない]
- [例: 認可チェックはService層で実施]

### 5.2 データ保護

- [例: パスワードはbcryptでハッシュ化]
- [例: 機微情報（PII）はログ出力禁止]
- [例: 秘密情報のハードコード禁止、環境変数使用]

### 5.3 ログ

- [例: エラー発生時はスタックトレース含めてログ出力]
- [例: ユーザー操作は監査ログとして記録]

---

## 6. テスト

### 6.1 テスト種別と責務

| 層 | テスト種別 | 必須/任意 |
|----|-----------|----------|
| Service | Unit Test | 必須 |
| Repository | Integration Test | 必須 |
| API | E2E Test | 必須 |
| Component | Unit Test | 任意 |

### 6.2 テストケース

- [例: 正常系 + 代表的な異常系は必須]
- [例: 境界値テストを含める]

### 6.3 命名・配置

- [例: `*.test.ts` または `*.spec.ts`]
- [例: テスト対象ファイルと同階層に配置]

---

## 7. AI固有の禁止事項

> AIがコード生成時に守るべき追加ルール

- **変更禁止範囲**: public API仕様・メソッドシグネチャは変更禁止（変更が必要な場合は提案にとどめる）
- **仕様追加禁止**: 仕様にない機能を勝手に追加しない（提案にとどめる）
- **ロールバック禁止**: テスト失敗時は原因を修正し、謎のロールバックをしない
- **スコープ厳守**: 指示された範囲外のファイルを変更しない

---

## 更新履歴

> ルール追加時は「理由」を必ず記録する（なぜこのルールが必要になったか）

| 日付 | 変更内容 | 理由 |
|------|---------|------|
| YYYY-MM-DD | 初版作成 | /draft-rulesで生成 |

---

## ルール追加の判断基準

以下に該当する場合、このドキュメントに追加する：

1. **再発可能性**: 他のL3実装でも同じ問題が起きそう
2. **致命度**: セキュリティ・データ破損・本番障害に関わる
3. **汎用性**: ルールとして一般化できる

該当しない場合は、当該L3に注記するにとどめる。
