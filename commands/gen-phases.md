---
description: L2 技術基盤からフェーズ定義・機能一覧（phases.md）を生成する
argument-hint: "[--include-setup] - オプション: 環境構築フェーズを含める（デフォルト: true）"
allowed-tools: Read, Write, Edit, Glob, Grep
---

# フェーズ定義生成コマンド

<tri_ssd_context>
Tri-SSD（Tri-Layer Slice Spec Driven）はAI/LLMコードエージェントを前提とした仕様駆動開発。

レイヤー構造:
- L1: ビジョン・要求（docs/l1_vision.md）
- L2: 技術基盤（docs/l2_system/）- foundation.md, phases.md, rules.md
- L3: 機能仕様（docs/l3_features/PH-xxx_name/F-xxx.md）

ID形式: PREFIX-YYYYMMDD-nnn（REQ, PH, F, NF）
ステータス: draft → reviewed → implemented（L3のみ）
</tri_ssd_context>

## 概要

L2 技術基盤（foundation.md）をベースに、フェーズ定義・機能一覧（phases.md）を生成する。

**前提**: foundation.md が確定（reviewed）していること。技術スタックが決まっていないとフェーズ計画は立てられない。

## 生成時の原則

<avoid_over_engineering>
- **フェーズを細かく分けすぎない**: 2〜5フェーズ程度が適切（10フェーズ以上は過剰）
- 各フェーズは「デモ可能な成果物」を出せる単位にする
- Exit Criteriaは3〜7項目程度（多すぎると管理困難）
- 機能の依存関係を厳密に管理しすぎない（記載順で十分）
- 最初のフェーズは小さく、早く成果を出せる構成にする
</avoid_over_engineering>

## 引数

- `--include-setup`: 環境構築フェーズを含める（デフォルト: true）
- `--skip-setup`: 環境構築フェーズをスキップ

## 前提処理

1. `docs/l1_vision.md` を読み込み、要件を把握する
2. `docs/l2_system/foundation.md` を読み込み、**技術スタックを把握する**
3. **`docs/l2_system/phases.md` が存在するか確認**（再生成モード判定）

---

## 出力フォーマット（必須）

### YAMLフロントマター

```yaml
---
id: PH-YYYYMMDD-nnn
kind: phase
layer: L2
status: active
doc_status: draft
---
```

**重要**: フロントマターは必ず上記形式で出力する。`---` で囲み、インデントなし。

### 必須構造

```markdown
# [プロダクト名] フェーズ定義・機能一覧

## フェーズ間依存関係図

（ASCII図でフェーズ間の依存関係を表現）

## PH-YYYYMMDD-ENV: 環境構築

### 目的
- **ユーザー視点**: ...
- **アーキテクチャ視点**: ...

### Exit Criteria
- [ ] 開発環境が構築できる
- [ ] ...

### 対象タスク
1. プロジェクト初期化
2. ...

### リスク・前提条件
| リスク/前提 | 対策/確認方法 |

---

## PH-YYYYMMDD-001: [フェーズ名]

### 目的
- **ユーザー視点**: ...
- **アーキテクチャ視点**: ...

### Exit Criteria
- [ ] ...

### フェーズ境界テスト
- ...

### 機能一覧（実装順）

| 機能ID | 機能名 | 概要 | 優先度 | ステータス |
|--------|--------|------|--------|-----------|
| F-YYYYMMDD-nnn | ... | ... | Must | pending |

### リスク・前提条件
| リスク/前提 | 対策/確認方法 |

---

## 全体機能一覧

| 機能ID | 機能名 | 対応REQ | フェーズ | 優先度 | ステータス |
|--------|--------|---------|----------|--------|-----------|

## 更新履歴
| 日付 | 変更内容 | 担当 |
```

**必須**: 各フェーズに Exit Criteria、機能一覧、リスク・前提条件を含める
**記載順 = 実装順**

## 再生成モード（既存ファイルがある場合）

既存の `phases.md` がある場合は**再生成モード**で動作する。

### 保持するもの（上書きしない）

| セクション | 理由 |
|-----------|------|
| Exit Criteria のチェック状態 | 進捗を保持（`[x]` を消さない） |
| 完了済みフェーズの内容 | 実績として保持 |
| 機能のステータス（実装中/完了） | 進捗を保持 |
| 更新履歴 | 変更の経緯を保持 |
| リスク・前提条件の対策結果 | 実績として保持 |

### 更新するもの

| セクション | 条件 |
|-----------|------|
| 未着手フェーズの機能一覧 | L1/foundation変更時 |
| フェーズ間依存関係図 | フェーズ構成変更時 |
| 新規機能の追加 | L1に新しいREQが追加された場合 |
| 優先度 | 明示的な変更要求時 |

### 再生成時の手順

1. 既存ファイルを読み込み、各フェーズ・機能のステータスを把握
2. 完了済み/実装中の機能は**触らない**
3. L1/foundationとの差分を分析
4. ユーザーに「何を更新するか」を確認（新規機能追加、フェーズ再構成等）
5. 未着手部分のみ更新、完了部分は保持
6. 更新履歴セクションに今回の変更を追記

## 生成手順

### Step 1: foundation.md 確認

- `doc_status` が `reviewed` であることを確認
- `draft` の場合は警告を出し、続行するか確認する
- 技術スタックを把握

### Step 2: 機能分解

- L1の要件を機能候補に分解
- 機能IDはF-YYYYMMDD-nnn形式で採番
- 各機能に**優先度**（Must/Should/Could）を設定

### Step 3: 環境構築フェーズ生成（--skip-setup でない場合）

選定された技術スタックに基づいて、以下のタスクを含むフェーズを生成:

**PH-YYYYMMDD-ENV: 環境構築**
- プロジェクト初期化（例: Next.jsセットアップ）
- DB/ORMセットアップ（例: Prisma + PostgreSQL）
- 認証基盤（例: NextAuth.js）
- CI/CD設定（例: GitHub Actions）
- 開発環境構築（例: Docker Compose）

**リスク・前提条件**も必ず記載:
- 外部サービスのアカウント/認証情報の準備状況
- チームメンバーの環境準備状況

### Step 4: フェーズ設計

<thinking_process>
フェーズ設計前に、以下を判断する：

1. **適切なフェーズ数は？**
   - 小規模（機能5個以下）: 2フェーズ（環境構築 + コア機能）
   - 中規模（機能6〜15個）: 3〜4フェーズ
   - 大規模（機能16個以上）: 4〜5フェーズ

2. **各フェーズの境界は？**
   - 「この時点でユーザーに見せられるか？」で判断
   - 技術的な区切りより、ビジネス価値の区切りを優先

3. **最初のフェーズに何を入れるか？**
   - 早く成果を出せる機能を優先
   - 依存関係の根幹となる機能を含める
</thinking_process>

- 機能を「結合して意味のある単位」でグルーピング
- 各フェーズに以下を定義:
  - **目的**: ユーザー視点 + アーキテクチャ視点
  - **Exit Criteria**: 完了条件（チェックリスト形式、3〜7項目）
  - **フェーズ境界テスト**: 結合/E2Eテストの概要
  - **リスク・前提条件**: 各フェーズ固有のリスクと前提
- 記載順＝実装順

### Step 5: フェーズ間依存関係の可視化

ASCII図でフェーズ間の依存関係を表現:

```
PH-ENV (環境構築)
    │
    ▼
PH-001 (基盤フェーズ)
    │
    ├──▶ PH-002 (機能拡張A)
    │
    └──▶ PH-POC (検証フェーズ)
```

### Step 6: 全体俯瞰用機能一覧作成

- 全機能の一覧テーブルを作成
- 含める列: 機能ID、機能名、対応REQ、フェーズ、依存、**優先度**、ステータス

### Step 7: POC/検証フェーズの検討

技術的な不確実性がある場合:
- POCフェーズを追加
- **検証結果の反映先**を明記（採用時→どのフェーズ、不採用時→foundation.md）
- 成功基準を定義

## ID採番ロジック

### フェーズID（PH）
1. 現在日時を取得: YYYYMMDD
2. 既存PH IDを検索（Grepで docs/**/*.md から）
3. 同日の最大連番 + 1 で新ID生成
4. 環境構築フェーズは `PH-YYYYMMDD-ENV` 形式

### 機能ID（F）
1. 現在日時を取得: YYYYMMDD
2. 既存F IDを検索（Grepで docs/**/*.md から）
3. 同日の最大連番 + 1 で新ID生成

## 出力ファイル

| ファイル |
|---------|
| `docs/l2_system/phases.md` |

## 生成時の注意

- **リスク・前提条件は必ず埋める**: 空欄のままにしない。該当なしの場合は「特になし」と明記
- **優先度は慎重に**: Must を付けすぎない。本当に Exit Criteria に必要なものだけ
- **依存関係は参考情報**: 厳密な管理は不要、記載順で実装順を表現

## 完了後の案内

- 生成ファイルのパスを報告
- `/draft-rules` で実装ルールを生成することを案内
- `/gen-l3` で L3 機能ドキュメントを生成することを案内
- `/check` で整合性チェックを案内

