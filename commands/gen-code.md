---
description: L3機能ドキュメントからコードとテストを生成する
argument-hint: <F-ID> - 対象の機能ID（必須）
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---

# コード生成コマンド

<tri_ssd_context>
Tri-SSD（Tri-Layer Slice Spec Driven）はAI/LLMコードエージェントを前提とした仕様駆動開発。

レイヤー構造:
- L1: ビジョン・要求（docs/l1_vision.md）
- L2: 技術基盤（docs/l2_system/）- foundation.md, phases.md, rules.md
- L3: 機能仕様（docs/l3_features/PH-xxx_name/F-xxx.md）

ID形式: PREFIX-YYYYMMDD-nnn（REQ, PH, F, NF）
ステータス: draft → reviewed → implemented（L3のみ）
</tri_ssd_context>

## 概要

L3 機能ドキュメントを入力として、テストコードと実装コードを生成する。
テスト駆動で実装し、検証ループで品質を担保する。

## コード生成時の原則

<avoid_over_engineering>
- L3に書かれていない機能を追加しない
- 「念のため」のエラーハンドリングを過剰に入れない
- 既存コードのパターンに合わせる（新しいパターンを導入しない）
- rules.md に従う（独自ルールを作らない）
- 最小限の実装から始める
</avoid_over_engineering>

## 引数

- `$1`: 対象の機能ID（必須）
  - 例: `F-20250125-001`

## 前提条件

- L3 ドキュメントが `reviewed` 状態であること（draft の場合は警告し、続行確認）
- プロジェクト設定ファイルが存在すること（package.json, pyproject.toml 等）

## 実行フロー

### Phase 1: コンテキスト収集

1. **L3ファイル特定**: Glob で `docs/l3_features/**/$1*.md` を検索（フェーズフォルダ内）
   - 見つからない場合はエラー終了
2. L3 ドキュメントを読み込み、`doc_status` を確認
   - `draft` の場合：警告「L3が未レビューです。続行しますか？」
3. **プロジェクト設定を自動検出**:
   - `package.json` あり → `npm test`, `npm run lint`
   - `pyproject.toml` あり → `pytest`, `ruff check`
   - `go.mod` あり → `go test ./...`, `golangci-lint run`
   - `Makefile` あり → `make test`, `make lint`
   - 検出できない場合 → ユーザーに1回だけ確認
4. `docs/l2_system/rules.md` があれば実装制約を把握（任意）
5. **既存コード確認**: Glob/Grep で関連ファイルを検索
   - 同名ファイルがある場合 → **再生成モード**へ

## 再生成モード（既存コードがある場合）

既存の実装/テストファイルがある場合は**再生成モード**で動作する。

<thinking_process>
再生成時の判断基準:

1. **既存テストをどうするか？**
   - L3の受け入れ条件が変更 → テストも再生成
   - 受け入れ条件は同じ → 既存テストを維持
   - 不明な場合 → ユーザーに確認

2. **既存実装をどうするか？**
   - L3のインターフェースが変更 → 実装も再生成
   - 内部ロジックのみ変更 → 差分更新
   - 不明な場合 → ユーザーに確認
</thinking_process>

### 再生成時の確認

```markdown
既存コードが見つかりました:
- テスト: tests/features/xxx.test.ts
- 実装: src/features/xxx.ts

どのように進めますか？
1. **全て再生成**: 既存を破棄し、L3から新規生成
2. **テストのみ再生成**: 実装は維持、テストを更新
3. **実装のみ再生成**: テストは維持、実装を更新
4. **差分確認**: L3との差分を表示してから判断
5. **キャンセル**: 何もしない
```

### Phase 2: 実装計画の確認

L3 から以下を抽出し、ユーザーに確認:

```markdown
## 実装計画

**対象機能**: [機能名]
**検出した環境**: [package.json / pyproject.toml / etc.]

### 生成予定ファイル

| 種別 | パス | 説明 |
|------|------|------|
| テスト | tests/... | [概要] |
| 実装 | src/... | [概要] |

### 受け入れ条件 → テストケース

| AC | テストケース |
|----|-------------|
| AC-1 | [テスト概要] |
| AC-2 | [テスト概要] |

この計画で進めますか？ (yes/no/修正)
```

### Phase 3: テスト生成

<thinking_process>
ファイルパス決定の判断基準:

1. **既存コードのパターンは？**
   - Glob で類似ファイルを検索し、配置パターンを推測
   - テストの配置: `tests/`, `__tests__/`, `*_test.py` 等

2. **インターフェース種別は？**
   - API → `src/api/`, `tests/api/`
   - UI → `src/components/`, `tests/components/`
   - CLI → `src/cli/`, `tests/cli/`
   - ライブラリ → `src/lib/`, `tests/lib/`
</thinking_process>

1. **ファイルパス決定**: 既存コードのパターンから決定
2. 受け入れ条件（AC）からテストコードを生成
3. 自動検出したテストツールを使用（jest, pytest 等）
4. rules.md のテスト規約に従う（存在する場合）

**テスト生成の原則**:
- 受け入れ条件を忠実にテスト化
- 境界値・異常系も含める（L3に記載がある場合）
- モック/スタブは最小限

### Phase 4: コード生成

1. L3 のタスクチェックリストに沿って実装
2. rules.md の実装ルールを適用
3. 既存コードのパターンに合わせる

**コード生成の原則**:
- L3 のインターフェース定義に厳密に従う
- 既存コードのエラー処理パターンに合わせる
- 命名規則は rules.md または既存コードに従う

### Phase 5: 検証ループ

1. **Lint実行** → 失敗時は自動修正（--fix）して再実行
2. **テスト実行** → 失敗時はエラー分析・修正して再実行
3. **最大3回失敗で中断**（circuit-breaker）

**検証ループの原則**:
- 各反復でエラー内容を分析し、異なるアプローチを試す
- 同じエラーが続く場合は早期中断

**実装中のメモ取り**:
- 問題発見・解決時は**都度** L3 の実装メモ（7.3 技術的負債、7.4 注意点）に記録
- 「後でまとめて書く」は忘れるので、発見時点で 1 行でも追記する
- 記録すべき内容: 想定外の動作、回避策、ライブラリの制約、設計判断の理由

### Phase 6: L3 更新

実装完了後、L3 ドキュメントを更新:

1. **タスクチェックリスト**: 完了タスクに `[x]` マーク
2. **実装メモ（7.2 関連コードへのリンク）**: 生成したファイルパスを記載
3. **技術的負債（7.3）**: 暫定対応があれば記録

### Phase 7: 気づきの整理と反映提案

実装完了後、以下を確認してユーザーに提案する:

1. **実装メモの確認**: L3 に記録した気づき・問題点を一覧化
2. **rules.md への反映判断**: 以下に該当するものがあれば提案
   - 他の機能でも適用すべきルール
   - プロジェクト全体で統一すべき規約
   - 今後も注意が必要な制約・回避策

**提案形式**:
```markdown
## 💡 気づきの反映提案

実装中に以下の知見が得られました:
- [知見1の内容]
- [知見2の内容]

**rules.md への追加を検討しますか？**
- Yes: `/draft-rules` で rules.md に追記
- No: L3 の実装メモにのみ記録（現状維持）
```

**注**: 全ての気づきを rules.md に追加する必要はない。「他でも使える」ものだけ選別する。

## 出力形式

### 成功時
- 生成ファイル一覧（テスト、実装）
- テスト結果サマリ
- L3 更新内容（チェックリスト完了、コードパス追記）
- 次のステップ: `/review` で最終レビュー → `implemented` 昇格

### 失敗時
- エラー内容（最後のエラーログ）
- 試行した修正内容（3回分）
- 推奨アクション（L3見直し、手動デバッグ検討）

## 注意事項

- **draft L3の扱い**: 警告を出し、続行するか確認する（ブロックはしない）
- **既存コードの上書き確認**: 同名ファイルがある場合は再生成モードで対話確認
- **部分成功は認めない**: 全テスト通過が完了条件
- **rules.md 優先**: rules.md の制約とL3が矛盾する場合、rules.md を優先し警告を出す
- **検証コマンド不明時**: 自動検出できない場合、ユーザーに1回だけ確認する

## 完了後の案内

- 生成ファイル一覧を報告
- テスト結果サマリを報告
- 実装中の気づきがあれば一覧化し、rules.md への反映を提案
- `/review` で最終レビューを案内
- レビュー後の `implemented` 昇格を案内
