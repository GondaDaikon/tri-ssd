---
description: ドキュメントのdoc_statusを次の段階に昇格する
argument-hint: <ファイルパス|ID> - 昇格対象（必須）
allowed-tools: Read, Edit, Glob, Grep
---

# doc_status 昇格コマンド

## 概要

ドキュメントの `doc_status` を次の段階に昇格させるコマンドです。
昇格時には各段階で必要な条件をチェックし、満たしていない場合は警告を表示します。

## 引数

- `$1`: 昇格対象（必須）
  - ファイルパス: 直接ファイルを指定
  - ID: REQ-YYYYMMDD-nnn, F-YYYYMMDD-nnn 等の ID で指定

## 状態遷移

```
draft ──────> reviewed ──────> implemented
  ↑              │                  │
  └──────────────┴──────────────────┘
           (再ドラフト化も可能)
```

| 現在の状態 | 昇格後の状態 | 条件 |
|-----------|-------------|------|
| draft | reviewed | レビュー完了、TODO解消、整合性チェックOK |
| reviewed | implemented | 実装完了、テスト完了、コード同期 |
| implemented | - | 最終状態（再ドラフト化のみ可能） |

## エラー処理

### 引数がない場合

```
エラー: 昇格対象を指定してください。
使用方法: /promote-status <ファイルパス|ID>
例:
  /promote-status docs/l1_vision.md
  /promote-status F-20250125-001
  /promote-status REQ-20250125-001
```

### 指定されたファイルが存在しない場合

```
エラー: 指定されたファイルが見つかりません: [ファイルパス]
ファイルパスを確認してください。
```

### 指定された ID が見つからない場合

```
エラー: 指定された ID のドキュメントが見つかりません: [ID]
docs/ 配下を検索しましたが、該当するドキュメントがありません。

ヒント:
- /check --list-ids で存在する ID 一覧を確認できます
```

## 前提処理

1. `.claude/skills/ssdd.md` を読み込み、doc_status の定義を確認
2. `docs/templates/README.md` を読み込み、状態遷移ルールを確認
3. `$1` で指定された対象ファイルを特定・読み込む

## 昇格条件チェック

### draft → reviewed の条件

#### 必須条件（エラー）

- [ ] フロントマターに必須フィールドがすべて存在
  - id, kind, layer, status, doc_status
- [ ] フロントマター直後に `# 見出し` が存在（v2.0）
- [ ] L3（kind: feature）の場合、phase と req_ids が存在
- [ ] 参照整合性が保たれている
  - req_ids の参照先が存在
  - nfr_ids の参照先が存在
  - phase の参照先が存在

#### 推奨条件（警告）

- [ ] TODO コメント（`<!-- TODO: 要確認 -->`）が残存していない
- [ ] 本文に `[xxx]` などのプレースホルダーが残存していない
- [ ] レイヤに応じた必須セクションが存在
  - L1: プロダクトの目的、制約条件、機能要求
  - L2: 用語集、技術方針、フェーズ定義
  - L3: 概要、入出力、業務ルール、タスクリスト、受け入れ条件

### reviewed → implemented の条件

#### 必須条件（エラー）

- [ ] kind が feature である（L3機能ドキュメントのみ implemented にできる）
- [ ] タスクチェックリストがすべて完了
  - `- [ ]` → `- [x]` に変更されている
- [ ] 実装メモセクションに関連コードパスが記載されている

#### 推奨条件（警告）

- [ ] 受け入れ条件（AC）がすべて満たされている旨が記載されている
- [ ] テストコードへのリンクが記載されている
- [ ] 技術的負債・暫定対応が文書化されている

## 実行内容

### Step 1: 対象ファイルの特定

- ファイルパスが指定された場合: そのファイルを対象
- IDが指定された場合: Grepで該当ファイルを検索

### Step 2: 現在のdoc_statusを取得

フロントマターから `doc_status` を読み取る。

### Step 3: 昇格条件チェック

現在の状態に応じた昇格条件をチェック：

- draft → reviewed: 上記チェック項目を実行
- reviewed → implemented: 上記チェック項目を実行
- implemented: エラー（最終状態）

### Step 4: チェック結果の表示

```markdown
# doc_status 昇格チェック結果

**ファイル**: docs/l3_features/F-20250125-001_xxx.md
**現在の状態**: draft
**昇格後の状態**: reviewed

## 必須条件

✓ フロントマター必須フィールド: すべて存在
✓ タイトル見出し: 存在
✓ 参照整合性: 問題なし

## 推奨条件

✗ TODO残存: 3箇所
  - 行42: <!-- TODO: 要確認 -->
  - 行58: <!-- TODO: 要確認 -->
  - 行71: <!-- TODO: 要確認 -->

⚠ プレースホルダー残存: 1箇所
  - 行35: [具体的な値を記載]

✓ 必須セクション: すべて存在

## 判定

必須条件: ✓ すべて満たしている
推奨条件: ⚠ 一部満たしていない（警告）

昇格可能ですが、推奨条件を満たすことを推奨します。
```

### Step 5: ユーザーに確認

```
昇格を実行しますか？

1. 実行（推奨条件の警告を無視して昇格）
2. キャンセル（修正してから再実行）
3. 強制実行（すべてのチェックをスキップ）
```

### Step 6: 昇格実行

ユーザーが「実行」または「強制実行」を選択した場合：

1. フロントマターの `doc_status` を更新
   ```yaml
   doc_status: reviewed  # draft から updated
   ```

2. 更新日時をフロントマターに追記（オプション）
   ```yaml
   updated_at: "2025-01-25"
   ```

3. 完了メッセージを表示
   ```
   ✓ doc_status を draft → reviewed に昇格しました。

   ファイル: docs/l3_features/F-20250125-001_xxx.md
   新しい状態: reviewed

   次のステップ:
   - 実装を開始してください
   - 実装完了後、/promote-status で implemented に昇格できます
   ```

## 再ドラフト化

implemented または reviewed 状態のドキュメントを draft に戻すことも可能です。

```bash
/promote-status --demote docs/l3_features/F-20250125-001_xxx.md
```

確認メッセージ：
```
警告: doc_status を reviewed → draft に降格します。
この操作により、ドキュメントがレビュー前の状態に戻ります。

理由を入力してください（記録用）:
> [大幅な設計変更のため]

降格を実行しますか？ (y/n)
```

## 出力例

### 成功時

```markdown
✓ doc_status 昇格完了

ファイル: docs/l3_features/F-20250125-001_login.md
ID: F-20250125-001
昇格: draft → reviewed

チェック結果:
- 必須条件: すべて満たしている
- 推奨条件: すべて満たしている

次のステップ:
- 実装フェーズに進んでください
- 実装完了後、/promote-status F-20250125-001 で implemented に昇格
```

### エラー時

```markdown
✗ doc_status 昇格失敗

ファイル: docs/l3_features/F-20250125-002_auth.md
ID: F-20250125-002
現在の状態: draft
昇格先: reviewed

必須条件エラー:
1. 参照整合性エラー
   - req_ids の REQ-20250125-999 が存在しない

2. 必須フィールド欠落
   - phase が未指定

修正方法:
1. req_ids を正しいIDに修正してください
2. phase フィールドを追加してください

修正後、再度 /promote-status を実行してください。
```

## 完了後の案内

- **draft → reviewed 昇格時**:
  - 次のステップ（実装開始）を案内
  - 関連ドキュメント（上位層）のレビューを推奨

- **reviewed → implemented 昇格時**:
  - フェーズ完了条件の確認を推奨
  - 結合テスト／E2Eテストの実施を案内

## 注意事項

- L1, L2 は implemented 状態にはなりません（draft → reviewed のみ）
- L3（kind: feature）のみ implemented 状態に昇格可能
- 状態の降格（demote）は慎重に行ってください
- 昇格履歴は Git コミットログで管理することを推奨
