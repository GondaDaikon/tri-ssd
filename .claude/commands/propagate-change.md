---
description: ドキュメント変更の影響を分析し、関連ドキュメントへの伝播を支援する
argument-hint: <ファイルパス|ID> - 変更されたドキュメント（必須）
allowed-tools: Read, Edit, Glob, Grep, AskUserQuestion
---

# 変更伝播コマンド

## 概要

ドキュメントの変更内容を分析し、影響を受ける関連ドキュメントを特定します。
変更の種類に応じて、上位層・下位層への伝播が必要かを判定し、更新を支援します。

## 引数

- `$1`: 変更されたドキュメント（必須）
  - ファイルパス: 直接ファイルを指定
  - ID: REQ-YYYYMMDD-nnn, F-YYYYMMDD-nnn 等の ID で指定

## 変更伝播の原則

### 基本方針

```
L1 (要求) ────┐
              ↓ 影響大（設計変更必要）
L2 (設計) ────┐
              ↓ 影響中（実装変更必要）
L3 (機能) ────> コード
              ↑ フィードバック
```

### 伝播方向

| 変更層 | 影響方向 | 伝播の種類 |
|--------|---------|-----------|
| L1変更 | L2, L3, コード | 下方伝播（設計・実装に影響） |
| L2変更 | L3, コード | 下方伝播（実装に影響） |
| L2変更 | L1 | 上方伝播（要件影響時のみ） |
| L3変更 | コード | 下方伝播（実装に影響） |
| L3変更 | L2 | 上方伝播（設計影響時のみ） |
| コード変更 | L3 | 上方伝播（仕様同期） |

## エラー処理

### 引数がない場合

```
エラー: 変更対象を指定してください。
使用方法: /propagate-change <ファイルパス|ID>
例:
  /propagate-change docs/l1_vision.md
  /propagate-change F-20250125-001
  /propagate-change REQ-20250125-001
```

### 指定されたファイルが存在しない場合

```
エラー: 指定されたファイルが見つかりません: [ファイルパス]
ファイルパスを確認してください。
```

## 前提処理

1. `.claude/skills/ssdd.md` を読み込み、変更伝播ルールを確認
2. `docs/guide.md` の変更伝播セクションを読み込む
3. `$1` で指定された対象ファイルを読み込む
4. Git diff を使用して変更内容を取得（可能な場合）

## 実行内容

### Step 1: 変更内容の分析

変更されたドキュメントを分析し、以下を特定：

1. **変更の種類**
   - 新規追加
   - 内容変更
   - 削除・非推奨化

2. **変更の重大度**
   - Critical: 要件変更、API変更、破壊的変更
   - High: 機能追加、設計変更
   - Medium: 仕様明確化、詳細追加
   - Low: 誤字修正、フォーマット変更

3. **変更箇所**
   - フロントマター（メタ情報）
   - 要件・制約条件
   - 機能定義
   - 技術方針
   - 実装詳細

### Step 2: 影響範囲の特定

#### L1 変更時の影響分析

```markdown
## L1 変更の影響分析

### 変更内容
- REQ-20250125-003 の制約条件を追加
  - 「WCAG 2.2 AA準拠」を追加

### 影響を受けるドキュメント

#### L2 への影響（必須）
- docs/l2_system/overview.md
  - セクション 4.1: 技術選定への影響
  - セクション 7: NFRカタログへの追加が必要
  - **対応**: NF-20250125-005 として新規NFRを追加

- docs/l2_system/phases.md
  - PH-20250125-001 の完了条件に影響
  - **対応**: アクセシビリティテストの追加

#### L3 への影響（必須）
- docs/l3_features/F-20250125-001_login.md
  - req_ids に REQ-20250125-003 を追加
  - セクション 5.1: 非機能要求の具体化に追記
  - **対応**: アクセシビリティ要件の具体化

- docs/l3_features/F-20250125-002_dashboard.md
  - 同上

#### コードへの影響（必須）
- すべての UI コンポーネント
  - aria-label, role 属性の追加
  - キーボードナビゲーション対応
```

#### L2 変更時の影響分析

```markdown
## L2 変更の影響分析

### 変更内容
- 技術スタック変更: Zustand → Redux Toolkit
  - セクション 4.1: 状態管理ライブラリの変更

### 影響を受けるドキュメント

#### L1 への影響確認（条件付き）
⚠ 要件への影響を確認：
- この変更は L1 の制約条件に抵触しますか？
  - 「軽量なライブラリ」という制約がある場合は影響あり
  - **判定**: 影響なし（技術選定の自由度内）

#### L3 への影響（必須）
- docs/l3_features/F-20250125-001_login.md
  - セクション 6.1: 状態管理パターンの変更
  - セクション 6.2: 関連コードパスの更新
  - **対応**: Redux Toolkit パターンに更新

- docs/l3_features/F-20250125-003_settings.md
  - 同上

#### コードへの影響（必須）
- src/store/ 配下のすべてのファイル
  - Zustand → Redux Toolkit への移行
  - テストコードの更新
```

#### L3 変更時の影響分析

```markdown
## L3 変更の影響分析

### 変更内容
- F-20250125-001: ログイン機能の実装詳細を追加
  - セクション 3.1: バリデーションルールを明確化

### 影響を受けるドキュメント

#### L2 への影響確認（条件付き）
⚠ 設計への影響を確認：
- この変更は L2 の機能定義・技術方針に影響しますか？
  - バリデーションルールが新しい技術要素を必要とする場合は影響あり
  - **判定**: 影響なし（既存技術で実装可能）

#### コードへの影響（必須）
- src/features/auth/LoginForm.tsx
  - バリデーションロジックの更新
- tests/features/auth/LoginForm.test.tsx
  - テストケースの追加
```

### Step 3: 変更伝播タスクの生成

影響を受けるドキュメントごとに、更新タスクを生成：

```markdown
## 変更伝播タスク

### 優先度: Critical

#### タスク1: L2 overview.md の更新
- **ファイル**: docs/l2_system/overview.md
- **セクション**: 7. 非機能要求カタログ
- **変更内容**: NF-20250125-005 を追加
- **見積**: 15分

```diff
+ | NF-20250125-005 | WCAG 2.2 AA準拠 | アクセシビリティ基準 | アクセシビリティ | Must | 全機能 | axe DevTools |
```

#### タスク2: L3 F-20250125-001 の更新
- **ファイル**: docs/l3_features/F-20250125-001_login.md
- **セクション**: 5.1 非機能要求の具体化
- **変更内容**: アクセシビリティ要件を追加
- **見積**: 20分

```markdown
| NF-20250125-005 | WCAG 2.2 AA準拠 | フォーム要素にaria-label付与、キーボード操作対応 |
```

### 優先度: High

#### タスク3: L3 F-20250125-002 の更新
...
```

### Step 4: 対話的確認

ユーザーに変更伝播の実行を確認：

```
変更伝播タスクを検出しました。

影響を受けるドキュメント: 5件
- L2: 2件
- L3: 3件

推定作業時間: 1時間15分

どのように進めますか？

1. すべて自動更新（AI がドラフトを生成）
2. タスクリストのみ表示（手動更新）
3. ドキュメントごとに確認（対話的更新）
4. キャンセル
```

### Step 5: 更新実行

ユーザーの選択に応じて更新を実行：

#### オプション1: すべて自動更新

各ドキュメントに対して：
1. Read ツールで対象ファイルを読み込む
2. 変更箇所を特定
3. Edit ツールで更新を適用
4. doc_status を draft に変更（レビュー必要）

#### オプション2: タスクリストのみ表示

Markdown形式のタスクリストを出力：

```markdown
# 変更伝播タスクリスト

## REQ-20250125-003 の変更に伴う更新

### L2 更新

- [ ] docs/l2_system/overview.md
  - セクション 7: NF-20250125-005 を追加
  - 見積: 15分

- [ ] docs/l2_system/phases.md
  - PH-20250125-001: アクセシビリティテストを追加
  - 見積: 10分

### L3 更新

- [ ] docs/l3_features/F-20250125-001_login.md
  - セクション 5.1: NF-20250125-005 の具体化
  - 見積: 20分

...
```

#### オプション3: ドキュメントごとに確認

各ドキュメントについて：
1. 変更内容を表示
2. ユーザーに確認
3. 承認された場合のみ更新

### Step 6: 完了報告

```markdown
# 変更伝播完了

## 更新されたドキュメント

✓ docs/l2_system/overview.md
  - NF-20250125-005 を追加
  - doc_status: draft（レビュー必要）

✓ docs/l2_system/phases.md
  - PH-20250125-001 更新
  - doc_status: draft（レビュー必要）

✓ docs/l3_features/F-20250125-001_login.md
  - req_ids 追加、NFR具体化
  - doc_status: draft（レビュー必要）

⚠ docs/l3_features/F-20250125-002_dashboard.md
  - 手動更新が必要（複雑な変更のため）

## 次のステップ

1. 更新されたドキュメントをレビュー
2. /check で整合性を確認
3. /review [ID] で各ドキュメントをレビュー
4. /promote-status [ID] で reviewed に昇格
```

## 変更の種類別の伝播パターン

### パターンA: 要件追加（L1）

```
L1: 新規 REQ 追加
  ↓
L2: 機能追加、NFR追加、フェーズ更新
  ↓
L3: 新規機能Doc作成、既存機能への影響
  ↓
コード: 実装
```

**伝播範囲**: 全層

### パターンB: 要件変更（L1）

```
L1: 既存 REQ 変更
  ↓
L2: 機能定義変更、技術方針見直し
  ↓
L3: 機能Doc更新
  ↓
コード: 実装変更
```

**伝播範囲**: 全層

### パターンC: 技術方針変更（L2）

```
L2: 技術スタック変更
  ↓
L3: 実装パターン更新
  ↓
コード: リファクタリング
```

**伝播範囲**: L2以下

### パターンD: 実装詳細変更（L3）

```
L3: 仕様明確化
  ↓
コード: 実装変更
```

**伝播範囲**: L3以下

### パターンE: 実装からのフィードバック

```
コード: 設計上の問題発見
  ↑
L3: 機能Doc更新
  ↑
L2: 設計見直し（必要に応じて）
  ↑
L1: 要件見直し（必要に応じて）
```

**伝播範囲**: 上方伝播（影響に応じて）

## 出力例

### 詳細モード

```markdown
# 変更伝播分析結果

## 変更元ドキュメント

- **ファイル**: docs/l1_vision.md
- **ID**: VISION-0001
- **変更種類**: 要件追加
- **重大度**: High

## 変更内容

### REQ-20250125-003: アクセシビリティ対応
- WCAG 2.2 AA準拠を新規要件として追加
- 対象: すべての UI コンポーネント

## 影響分析

### 下方伝播（必須）

#### L2 への影響
- **docs/l2_system/overview.md** [Critical]
  - NFRカタログへの追加が必要
  - 技術選定への影響確認が必要

- **docs/l2_system/phases.md** [High]
  - PH-20250125-001 の完了条件更新
  - テスト計画への追加

#### L3 への影響
- **docs/l3_features/F-20250125-001_login.md** [High]
- **docs/l3_features/F-20250125-002_dashboard.md** [High]
- **docs/l3_features/F-20250125-003_settings.md** [Medium]

合計: 5 ドキュメント

## 推奨アクション

1. 即座に対応（Critical）
   - L2 overview.md の NFR追加

2. 早期対応（High）
   - L2 phases.md の更新
   - L3 各機能Docの更新

3. 計画的対応（Medium）
   - 実装計画の見直し
   - スプリント計画への反映

## 作業見積

- 更新時間: 約2時間
- レビュー時間: 約1時間
- **合計**: 約3時間
```

## 注意事項

- 変更伝播は影響分析から始め、機械的に更新しない
- Critical な変更は必ずユーザー確認を取る
- 自動更新後は必ず doc_status を draft に戻す
- 整合性チェック（/check）を実行して確認
- Git コミットは変更伝播の単位で行うことを推奨

## 完了後の案内

- 更新されたドキュメント一覧を表示
- 整合性チェック（/check）の実行を推奨
- レビュー（/review）の実行を推奨
- doc_status の昇格（/promote-status）を案内
