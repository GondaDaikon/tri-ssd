---
description: SSDDドキュメントの整合性をチェックする
argument-hint: "[--list-ids | ファイルパス] - オプション"
allowed-tools: Read, Glob, Grep
---

# 整合性チェックコマンド

## 引数

- `$1`: オプション（省略可）
  - `--list-ids`: 全 ID 一覧を出力
  - ファイルパス: 指定ファイルのみをチェック
  - 省略時: 全ドキュメントをチェック

## 前提処理

1. `.claude/skills/ssdd_core.md` を読み込み、SSDD の基本概念を把握する
2. `docs/templates/README.md` を読み込み、フロントマター仕様を確認する

## エラー処理

### docs ディレクトリが存在しない場合

```
エラー: docs/ ディレクトリが見つかりません。
先に /init-ssdd を実行してください。
```

### チェック対象のドキュメントがない場合

```
警告: チェック対象のドキュメントが見つかりません。
以下のディレクトリにドキュメントを配置してください:
- docs/l1_vision/
- docs/l2_system/
- docs/l3_features/

または /draft-l1 で L1 の作成から始めてください。
```

### 指定されたファイルが存在しない場合

```
エラー: 指定されたファイルが見つかりません: [ファイルパス]
ファイルパスを確認してください。
```

## 実行内容

### モード1: `--list-ids`

全ドキュメントのフロントマターから ID を抽出し、テーブル形式で一覧を出力。

**出力形式：**

```markdown
# ID一覧

## Active

| ID | Kind | Layer | Doc Status |
|----|------|-------|-----------|
| VISION-0001 | vision | L1 | reviewed |
| REQ-20250125-001 | req | L1 | reviewed |
| PH-20250125-001 | phase | L2 | reviewed |
| F-20250125-001 | feature | L3 | draft |
| NF-20250125-001 | nfr | L2 | reviewed |

## Deprecated/Removed

| ID | Kind | Layer | Status |
|----|------|-------|--------|
| REQ-20241201-010 | req | L1 | deprecated |
| F-20241215-005 | feature | L3 | removed |

## 統計

| 項目 | 件数 |
|------|------|
| Active | xx |
| Deprecated | xx |
| Removed | xx |
| **総計** | **xx** |
```

### モード2: 単一ファイルチェック

指定されたファイルに対して全チェック項目を実行。

### モード3: 全体チェック（デフォルト）

`docs/` 配下の全ドキュメントに対して全チェック項目を実行。

---

## チェック項目

### 1. フロントマター検査

#### 1-1: 共通必須フィールド（全ドキュメント）

以下が欠落していれば **エラー**：

| フィールド | 説明 |
|-----------|------|
| id | 一意なID |
| kind | ドキュメント種別 |
| layer | 所属レイヤ |
| status | ライフサイクル状態 |
| doc_status | 文書・開発状態 |

#### 1-2: L3 専用必須フィールド

L3（kind: feature）の場合、以下も必須。欠落は **エラー**：

| フィールド | 説明 |
|-----------|------|
| phase | 所属フェーズ（PH-xxxx） |
| req_ids | 対応する要件ID（1つ以上） |

#### 1-3: フィールド値の妥当性

不正な値は **エラー**：

| フィールド | 有効な値 |
|-----------|---------|
| kind | vision, req, feature, nfr, phase, spike, overview |
| layer | L1, L2, L3, meta |
| status | active, deprecated, removed |
| doc_status | draft, reviewed, implemented |

#### 1-4: タイトル見出しの存在確認（v2.0以降）

v2.0以降、`title`フィールドは廃止され、本文の最初の`# 見出し`がタイトルとして扱われます。

**チェック内容**：

| 状態 | 判定 |
|------|------|
| フロントマター直後に `# 見出し` が存在 | ✓ OK |
| `# 見出し` が存在しない | ✗ **エラー**: タイトル見出しが必要 |
| `# 見出し` がフロントマターの直後にない | ⚠ **警告**: 見出しの位置を確認 |
| フロントマターに `title` フィールドが存在 | ⚠ **警告**: v2.0では廃止（削除推奨） |

**YAML解析の注意**：
- フロントマターは `---` で囲まれた YAML ブロック
- Read ツールで読み込み、YAML 部分と本文を分離して解析
- 本文の最初の行が `# ` で始まることを確認

---

### 2. 参照整合性検査

#### 2-1: req_ids の検査

各 `req_ids` について：

| 参照先の状態 | 判定 |
|-------------|------|
| L1 に存在し active | ✓ OK |
| L1 に存在し deprecated | ⚠ **警告**: deprecated への参照 |
| L1 に存在し removed | ⚠ **警告**: removed への参照（削除推奨） |
| L1 に存在しない | ✗ **エラー**: 参照先が存在しない |

#### 2-2: nfr_ids の検査

各 `nfr_ids` について：

| 参照先の状態 | 判定 |
|-------------|------|
| `docs/l2_system/nfr.md` に存在し active | ✓ OK |
| 存在し deprecated/removed | ⚠ **警告** |
| 存在しない | ✗ **エラー** |

#### 2-3: phase の検査

`phase` フィールドについて：

| 参照先の状態 | 判定 |
|-------------|------|
| `docs/l2_system/phases.md` に存在し active | ✓ OK |
| 存在し deprecated/removed | ⚠ **警告** |
| 存在しない | ✗ **エラー** |

---

### 3. トレーサビリティ検査

#### 3-1: REQ → F の連鎖

L1 の各 `REQ-YYYYMMDD-nnn` について：

| 状態 | 判定 |
|------|------|
| いずれかの F-YYYYMMDD-nnn の `req_ids` に含まれている | ✓ OK |
| どの F にも紐付いていない | ⚠ **警告**: 未実装の要件 |
| status が deprecated/removed | チェック対象外 |

#### 3-2: F（L2）→ L3 の連鎖

L2 の機能一覧（`features_index.md`）の各 `F-YYYYMMDD-nnn` について：

| 状態 | 判定 |
|------|------|
| `docs/l3_features/` に対応する L3 が存在 | ✓ OK |
| L3 が存在しない | ⚠ **警告**: 機能Docが未作成 |
| kind が spike（SP-YYYYMMDD-nnn） | チェック対象外（L3不要） |

#### 3-3: 孤立 L3 の検出

`docs/l3_features/` の各ファイルについて：

| 状態 | 判定 |
|------|------|
| L2 の機能一覧に含まれている | ✓ OK |
| L2 に含まれていない | ⚠ **警告**: 孤立した機能Doc |

---

### 4. TODO チェック

`<!-- TODO: 要確認 -->` の残存箇所を一覧化：

```markdown
### TODO 残存

| ファイル | 行番号 | 内容 |
|---------|--------|------|
| docs/l3_features/F-20250125-001_xxx.md | 42 | <!-- TODO: 要確認 --> |
```

---

## 出力形式

```markdown
# 整合性チェック結果

## エラー（修正必須）

| ファイル | 種別 | 内容 |
|---------|------|------|
| docs/l3_features/F-20250125-001_xxx.md | 参照エラー | req_ids の REQ-20250125-999 が存在しない |
| docs/l3_features/F-20250125-002_xxx.md | 必須フィールド欠落 | phase が未指定 |
| docs/l2_system/overview.md | タイトル見出し欠落 | フロントマター直後に # 見出しが必要 |

## 警告（確認推奨）

| ファイル | 種別 | 内容 |
|---------|------|------|
| docs/l1_vision.md | トレーサビリティ | REQ-20250125-005 がどの機能にも紐付いていない |
| docs/l3_features/F-20250125-003_xxx.md | 参照警告 | nfr_ids の NF-20250120-002 は deprecated |
| docs/l3_features/F-20241215-001_xxx.md | v2.0非推奨 | title フィールドが残存（削除推奨） |

## TODO 残存

| ファイル | 行番号 | 内容 |
|---------|--------|------|
| docs/l2_system/overview.md | 58 | <!-- TODO: 要確認 --> |

## サマリ

| 項目 | 件数 |
|------|------|
| チェック対象 | xx ファイル |
| エラー | xx 件 |
| 警告 | xx 件 |
| TODO | xx 件 |
```

---

## 修正提案

エラーがある場合、diff 形式で具体的な修正案を提示：

```markdown
## 修正提案

### docs/l3_features/F-20250125-001_xxx.md

**問題**: req_ids に存在しない ID が含まれている

```diff
---
id: F-20250125-001
kind: feature
layer: L3
- req_ids: [REQ-20250125-999]
+ req_ids: [REQ-20250125-001]
phase: PH-20250125-001
---
```

**適用方法**: 上記の修正を確認し、手動で適用してください。

---

### docs/l3_features/F-20250125-002_xxx.md

**問題**: 必須フィールド phase が欠落

```diff
---
id: F-20250125-002
kind: feature
layer: L3
req_ids: [REQ-20250125-002]
+ phase: PH-20250125-001
---
```

---

### docs/l2_system/overview.md

**問題**: タイトル見出しが欠落

```diff
---
id: L2-OVERVIEW
kind: overview
layer: L2
status: active
doc_status: draft
---
+
+ # [プロダクト名] 機能設計・技術方針
```
```

> **注意**: 修正提案は参考情報です。適用は人間が確認してから行ってください。

---

## 終了ステータス

| 状態 | 終了コード |
|------|-----------|
| エラー 0 件 | 正常終了 |
| エラー 1 件以上 | エラー一覧を表示 |

---

## 完了後の案内

- **エラーがある場合**: 修正提案を確認し、優先度の高いものから対応
- **警告がある場合**: トレーサビリティの観点で確認を推奨
- **TODO がある場合**: レビュー前に解消を推奨
- **全て OK の場合**: `/review` で詳細レビューを実行可能
