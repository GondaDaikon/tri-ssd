---
id: L2-YYYYMMDD-nnn
kind: foundation
layer: L2
status: active
doc_status: draft
---
<!-- 注: 実際の使用時は /gen-l2 がIDを自動採番します -->

<!--
  テンプレート使用ガイド:

  【必須セクション】
  - 2. L1の要約とトレーサビリティ方針
  - 3. 用語集（最低限の用語）
  - 4. 技術スタック・技術方針
  - 5. 全体アーキテクチャ（5.1のみでも可）

  【省略可能セクション】
  - 4.4 採用しなかった選択肢（検討していれば記載）
  - 5.2〜5.4 詳細構成（シンプルな構成なら省略可）
  - 6. セキュリティ方針（認証がない場合は大幅簡略化可）
  - 7. エラーハンドリング方針（シンプルなアプリなら省略可）
  - 8. ログ・監視方針（個人プロジェクトなら省略可）
  - 9. 非機能要求カタログ（L1で十分に記述していれば簡略化可）
  - 10. 開発環境要件（READMEで代替可能）

  【原則】
  - プロジェクト規模に見合った詳細度で書く
  - 個人プロジェクトにエンタープライズ級のセクションは不要
  - 不要なセクションは削除してよい
  - 「念のため」で技術スタックを追加しない
-->

# [プロダクト名] 技術基盤

## 1. ドキュメントの立ち位置

### 1.1 目的

本書は、L1 の要求を満たすための技術基盤（用語・技術選定・アーキテクチャ・NFR）の正本である。
本書の内容が確定した後、phases.md でフェーズ分け・機能一覧を定義する。

### 1.2 粒度

- コードレベルには踏み込まないが、API やモジュール単位までは言及しうる
- 詳細な実装は L3（機能ドキュメント）に委ねる

---

## 2. L1 の要約とトレーサビリティ方針

### 2.1 主要な要求サマリ

| REQ ID | 要求名 | 概要 |
|--------|--------|------|
| REQ-YYYYMMDD-001 | [要求名] | [概要] |
| REQ-YYYYMMDD-002 | [要求名] | [概要] |

### 2.2 トレーサビリティルール

- 各機能（F-YYYYMMDD-nnn）のフロントマターに `req_ids` として対応する REQ を記載
- 各フェーズ（PH-YYYYMMDD-nnn）のフロントマターに `related_nfr_ids` として適用 NF を記載

---

## 3. 用語集

| 用語 | 定義 | 出典 |
|------|------|------|
| [用語1] | [定義] | [REQ-xxxx / 業務資料名] |
| [用語2] | [定義] | [REQ-xxxx / 業務資料名] |
| [用語3] | [定義] | [REQ-xxxx / 業務資料名] |

---

## 4. 技術スタック・技術方針

### 4.1 クライアント側

| 項目 | 選定技術 | 理由 |
|------|---------|------|
| フレームワーク | [例：React] | [選定理由] |
| 状態管理 | [例：Zustand] | [選定理由] |
| UI ライブラリ | [例：Tailwind CSS] | [選定理由] |

### 4.2 サーバ側

| 項目 | 選定技術 | 理由 |
|------|---------|------|
| 言語 | [例：TypeScript] | [選定理由] |
| フレームワーク | [例：Express] | [選定理由] |
| ORM | [例：Prisma] | [選定理由] |

### 4.3 インフラ・その他

| 項目 | 選定技術 | 理由 |
|------|---------|------|
| DB | [例：PostgreSQL] | [選定理由] |
| インフラ | [例：AWS] | [選定理由] |
| CI/CD | [例：GitHub Actions] | [選定理由] |

### 4.4 採用しなかった選択肢

| 候補 | 不採用理由 |
|------|-----------|
| [候補技術1] | [理由] |
| [候補技術2] | [理由] |

---

## 5. 全体アーキテクチャ

### 5.1 コンポーネント構成

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   Client    │────▶│   Server    │────▶│  Database   │
│  (Browser)  │     │   (API)     │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
```

### 5.2 レイヤ構造

| レイヤ | 役割 | 主なコンポーネント |
|--------|------|-------------------|
| UI | ユーザーインターフェース | [コンポーネント名] |
| Application | ユースケース制御 | [サービス名] |
| Domain | ビジネスロジック | [エンティティ名] |
| Infrastructure | 外部システム連携 | [リポジトリ名] |

### 5.3 モジュール間の依存関係

- [モジュールA] → [モジュールB]：[依存の理由]
- [モジュールB] → [モジュールC]：[依存の理由]

### 5.4 ディレクトリ構成

```
project-root/
├── src/
│   ├── components/      # UIコンポーネント
│   ├── features/        # 機能単位のモジュール
│   ├── services/        # アプリケーションサービス
│   ├── domain/          # ドメインモデル
│   └── infrastructure/  # 外部連携
├── tests/
│   ├── unit/
│   └── integration/
└── docs/
    ├── l1_vision.md
    └── l2_system/
```

---

## 6. セキュリティ方針

### 6.1 認証・認可

| 項目 | 方針 | 実装方法 |
|------|------|---------|
| 認証方式 | [例：JWT] | [実装詳細] |
| セッション管理 | [例：トークンリフレッシュ] | [実装詳細] |
| 認可モデル | [例：RBAC] | [ロール定義] |

### 6.2 データ保護

| 対象 | 保護方法 |
|------|---------|
| 通信 | [例：HTTPS/TLS 1.3] |
| 保存データ | [例：AES-256暗号化] |
| 認証情報 | [例：bcrypt ハッシュ] |

### 6.3 考慮すべき脆弱性対策

| 脅威 | 対策 |
|------|------|
| XSS | [対策：例）出力エスケープ、CSP] |
| CSRF | [対策：例）CSRFトークン] |
| SQLi | [対策：例）パラメータ化クエリ] |

---

## 7. エラーハンドリング方針

### 7.1 エラー分類

| 分類 | 説明 | 対応方針 |
|------|------|---------|
| バリデーションエラー | ユーザー入力の不正 | 400系、ユーザーに詳細を提示 |
| 認証・認可エラー | 権限不足 | 401/403、ログイン画面へ誘導 |
| ビジネスルール違反 | 業務ロジック上の不整合 | 400系、業務的な説明を提示 |
| システムエラー | サーバー内部エラー | 500系、汎用メッセージ＋ログ記録 |

### 7.2 エラーレスポンス形式

```json
{
  "status": "error",
  "code": "ERROR_CODE",
  "message": "ユーザー向けメッセージ",
  "details": {}
}
```

### 7.3 エラーコード体系

| プレフィックス | 説明 | 例 |
|---------------|------|-----|
| VAL | バリデーション | VAL001 |
| AUTH | 認証・認可 | AUTH001 |
| BIZ | ビジネスルール | BIZ001 |
| SYS | システム | SYS001 |

---

## 8. ログ・監視方針

### 8.1 ログレベル

| レベル | 用途 | 出力先 |
|--------|------|--------|
| ERROR | 要対応のエラー | 本番・開発 |
| WARN | 注意を要する状況 | 本番・開発 |
| INFO | 主要な処理の記録 | 本番・開発 |
| DEBUG | デバッグ用詳細情報 | 開発のみ |

### 8.2 ログ出力方針

| 出力タイミング | 出力内容 |
|---------------|---------|
| リクエスト受信時 | method, path, user_id |
| レスポンス送信時 | status, duration |
| エラー発生時 | error_code, message, stack_trace |
| 重要な状態変更時 | 変更内容、変更者 |

### 8.3 監視項目（本番運用時）

| 項目 | 閾値 | アラート方法 |
|------|------|-------------|
| エラー率 | [例：5%以上] | [例：Slack通知] |
| レスポンス時間 | [例：3秒超過] | [例：PagerDuty] |
| CPU使用率 | [例：80%以上] | [例：メール通知] |

---

## 9. 非機能要求カタログ

| NF ID | 名称 | 説明 | カテゴリ | 優先度 | 適用範囲 | テスト方法 |
|-------|------|------|---------|--------|----------|-----------|
| NF-YYYYMMDD-001 | レスポンス性能 | 3秒以内に応答 | 性能 | Must | 全機能 | 負荷テスト |
| NF-YYYYMMDD-002 | WCAG AA準拠 | アクセシビリティ基準 | アクセシビリティ | Must | 全機能 | axe DevTools |
| NF-YYYYMMDD-003 | 多言語対応 | 英語・日本語対応 | 国際化 | Should | F-YYYYMMDD-003以降 | i18nテスト |
| NF-YYYYMMDD-004 | データバックアップ | 日次自動バックアップ | 運用性 | Must | 全機能 | バックアップテスト |
| NF-YYYYMMDD-005 | 監査ログ | 操作履歴記録 | コンプライアンス | Could | 管理機能のみ | ログ確認 |

### 優先度の定義

| 優先度 | 説明 |
|--------|------|
| **Must** | 必須。満たさない場合はリリース不可 |
| **Should** | 強く推奨。満たすことが望ましいが、コスト次第で妥協可能 |
| **Could** | あれば良い。余裕があれば実装 |
| **Won't** | 今回は対象外。将来的に検討 |

---

## 10. 開発環境要件

### 10.1 必須ツール

| ツール | バージョン | 用途 |
|--------|-----------|------|
| [例：Node.js] | [例：20.x] | [用途] |
| [例：Docker] | [例：24.x] | [用途] |
| [例：Git] | [例：2.x] | [用途] |

### 10.2 環境構築手順

```bash
# 1. リポジトリのクローン
git clone [repository-url]

# 2. 依存関係のインストール
npm install

# 3. 環境変数の設定
cp .env.example .env

# 4. データベースのセットアップ
npm run db:setup

# 5. 開発サーバーの起動
npm run dev
```

### 10.3 外部サービス依存

| サービス | 用途 | 開発環境での代替 |
|----------|------|-----------------|
| [例：S3] | ファイル保存 | [例：MinIO / LocalStack] |
| [例：Auth0] | 認証 | [例：ローカルモック] |

---

## 11. 次のステップ

本書の内容が確定（`doc_status: reviewed`）したら、以下を実施する：

1. `/gen-phases` でフェーズ定義・機能一覧を生成
2. `/gen-rules` で実装ルールを生成

---

## 12. 更新・変更管理

### 12.1 L1 からの変更要求対応

1. L1 の変更内容を確認
2. 本ドキュメントへの影響を AI で分析
3. 影響箇所を更新し、レビューを依頼

### 12.2 L3 / 実装からのフィードバック

1. L3 または実装で発覚した問題を確認
2. 本ドキュメントへの反映が必要か判断
3. 必要な場合は該当箇所を更新

### 12.3 技術スタック変更時の合意フロー

1. 変更理由と影響範囲を明確化
2. アーキテクト／テックリードがレビュー
3. 重要な変更は PO にも共有
