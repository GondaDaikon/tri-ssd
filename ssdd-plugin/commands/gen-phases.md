---
description: L2 技術基盤からフェーズ定義・機能一覧（phases.md）を生成する
argument-hint: "[--include-setup] - オプション: 環境構築フェーズを含める（デフォルト: true）"
allowed-tools: Read, Write, Edit, Glob, Grep
---

# フェーズ定義生成コマンド

## 概要

L2 技術基盤（foundation.md）をベースに、フェーズ定義・機能一覧（phases.md）を生成する。

**前提**: foundation.md が確定（reviewed）していること。技術スタックが決まっていないとフェーズ計画は立てられない。

## 引数

- `--include-setup`: 環境構築フェーズを含める（デフォルト: true）
- `--skip-setup`: 環境構築フェーズをスキップ

## 前提処理

1. `skills/ssdd/SKILL.md` を読み込み、SSDD の基本概念を把握する
2. `skills/ssdd/templates/l2_phases.md` を読み込み、フェーズテンプレートを確認
3. `docs/l1_vision.md` を読み込み、要件を把握する
4. `docs/l2_system/foundation.md` を読み込み、**技術スタックを把握する**

## 生成手順

### Step 1: foundation.md 確認

- `doc_status` が `reviewed` であることを確認
- `draft` の場合は警告を出し、続行するか確認する
- 技術スタックを把握

### Step 2: 機能分解

- L1の要件を機能候補に分解
- 機能IDはF-YYYYMMDD-nnn形式で採番
- 各機能に**優先度**（Must/Should/Could）を設定

### Step 3: 環境構築フェーズ生成（--skip-setup でない場合）

選定された技術スタックに基づいて、以下のタスクを含むフェーズを生成:

**PH-YYYYMMDD-ENV: 環境構築**
- プロジェクト初期化（例: Next.jsセットアップ）
- DB/ORMセットアップ（例: Prisma + PostgreSQL）
- 認証基盤（例: NextAuth.js）
- CI/CD設定（例: GitHub Actions）
- 開発環境構築（例: Docker Compose）

**リスク・前提条件**も必ず記載:
- 外部サービスのアカウント/認証情報の準備状況
- チームメンバーの環境準備状況

### Step 4: フェーズ設計

- 機能を「結合して意味のある単位」でグルーピング
- 各フェーズに以下を定義:
  - **目的**: ユーザー視点 + アーキテクチャ視点
  - **Exit Criteria**: 完了条件（チェックリスト形式）
  - **フェーズ境界テスト**: 結合/E2Eテストの概要
  - **リスク・前提条件**: 各フェーズ固有のリスクと前提
- 記載順＝実装順

### Step 5: フェーズ間依存関係の可視化

ASCII図でフェーズ間の依存関係を表現:

```
PH-ENV (環境構築)
    │
    ▼
PH-001 (基盤フェーズ)
    │
    ├──▶ PH-002 (機能拡張A)
    │
    └──▶ PH-POC (検証フェーズ)
```

### Step 6: 全体俯瞰用機能一覧作成

- 全機能の一覧テーブルを作成
- 含める列: 機能ID、機能名、対応REQ、フェーズ、依存、**優先度**、ステータス

### Step 7: POC/検証フェーズの検討

技術的な不確実性がある場合:
- POCフェーズを追加
- **検証結果の反映先**を明記（採用時→どのフェーズ、不採用時→foundation.md）
- 成功基準を定義

## ID採番ロジック

### フェーズID（PH）
1. 現在日時を取得: YYYYMMDD
2. 既存PH IDを検索（Grepで docs/**/*.md から）
3. 同日の最大連番 + 1 で新ID生成
4. 環境構築フェーズは `PH-YYYYMMDD-ENV` 形式

### 機能ID（F）
1. 現在日時を取得: YYYYMMDD
2. 既存F IDを検索（Grepで docs/**/*.md から）
3. 同日の最大連番 + 1 で新ID生成

## 出力ファイル

| ファイル |
|---------|
| `docs/l2_system/phases.md` |

## 生成時の注意

- **リスク・前提条件は必ず埋める**: 空欄のままにしない。該当なしの場合は「特になし」と明記
- **優先度は慎重に**: Must を付けすぎない。本当に Exit Criteria に必要なものだけ
- **依存関係は参考情報**: 厳密な管理は不要、記載順で実装順を表現

## 完了後の案内

- 生成ファイルのパスを報告
- `/gen-rules` で実装ルールを生成することを案内
- `/gen-l3` で L3 機能ドキュメントを生成することを案内
- `/check` で整合性チェックを案内

## 環境構築フェーズの例

```markdown
## PH-20251127-ENV: 環境構築

### 目的

**開発者視点**:
- 開発環境が整い、最初の機能開発に着手できる状態にする

**アーキテクチャ視点**:
- foundation.md で定義した技術スタックの実環境を構築
- CI/CD パイプラインの基盤を整備

### 完了条件（Exit Criteria）

- [ ] プロジェクトが起動し、サンプルページが表示できる
- [ ] DBに接続でき、マイグレーションが成功する
- [ ] CI/CDパイプラインが動作する
- [ ] README.md に環境構築手順が記載されている

### リスク・前提条件

| 項目 | 内容 | 対策 |
|------|------|------|
| 外部サービス認証 | AWS/GCPの認証情報取得に時間がかかる可能性 | 早めに申請開始 |
| 前提条件 | チームメンバーが Docker をインストール済み | - |

### 対象タスク一覧（記載順＝実施順）

#### 1. プロジェクト初期化
- **ID**: ENV-001

Next.jsプロジェクトの作成、基本設定

#### 2. DB/ORMセットアップ
- **ID**: ENV-002

Prisma + PostgreSQL の設定、初期スキーマ作成

#### 3. 認証基盤
- **ID**: ENV-003

NextAuth.js の導入、基本認証フロー実装

#### 4. CI/CD設定
- **ID**: ENV-004

GitHub Actions の設定、テスト・デプロイパイプライン構築
```
