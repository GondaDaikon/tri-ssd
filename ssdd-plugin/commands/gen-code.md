---
description: L3機能ドキュメントからコードとテストを生成する
argument-hint: <F-ID> - 対象の機能ID（必須）
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---

# コード生成コマンド

<ssdd_context>
SSDD（Slices Specification-Driven Development）はAI/LLMコードエージェントを前提とした仕様駆動開発。

レイヤー構造:
- L1: ビジョン・要求（docs/l1_vision.md）
- L2: 技術基盤（docs/l2_system/）- foundation.md, phases.md, rules.md
- L3: 機能仕様（docs/l3_features/F-xxx.md）

ID形式: PREFIX-YYYYMMDD-nnn（REQ, PH, F, NF）
ステータス: draft → reviewed → implemented（L3のみ）
</ssdd_context>

## 概要

L3 機能ドキュメントを入力として、テストコードと実装コードを生成する。
テスト駆動で実装し、検証ループで品質を担保する。

## コード生成時の原則

<avoid_over_engineering>
- L3に書かれていない機能を追加しない
- 「念のため」のエラーハンドリングを過剰に入れない
- 既存コードのパターンに合わせる（新しいパターンを導入しない）
- rules.md に従う（独自ルールを作らない）
- 最小限の実装から始める
</avoid_over_engineering>

## 引数

- `$1`: 対象の機能ID（必須）
  - 例: `F-20250125-001`

## 前提条件

- L3 ドキュメントが `reviewed` 状態であること
- `docs/l2_system/foundation.md` が存在すること（技術スタック確認）
- `docs/l2_system/rules.md` が存在すること（実装ルール確認、任意だが推奨）

## 実行フロー

### Phase 1: コンテキスト収集

1. `$1` で指定された L3 ドキュメントを読み込む
2. `docs/l2_system/foundation.md` を読み込み、技術スタックを把握
3. `docs/l2_system/rules.md` を読み込み、実装制約を把握（存在する場合）
4. 既存コード構造を把握（Glob/Grep で関連ファイルを確認）

### Phase 2: 実装計画の確認

L3 から以下を抽出し、ユーザーに確認:

```markdown
## 実装計画

**対象機能**: [機能名]
**技術スタック**: [foundation.md から]

### 生成予定ファイル

| 種別 | パス | 説明 |
|------|------|------|
| テスト | tests/... | [概要] |
| 実装 | src/... | [概要] |

### 受け入れ条件 → テストケース

| AC | テストケース |
|----|-------------|
| AC-1 | [テスト概要] |
| AC-2 | [テスト概要] |

この計画で進めますか？ (yes/no/修正)
```

### Phase 3: テスト生成

1. 受け入れ条件（AC）からテストコードを生成
2. foundation.md のテストツール設定に従う
3. rules.md のテスト規約に従う

**テスト生成の原則**:
- 受け入れ条件を忠実にテスト化
- 境界値・異常系も含める（L3に記載がある場合）
- モック/スタブは最小限

### Phase 4: コード生成

1. L3 のタスクチェックリストに沿って実装
2. rules.md の実装ルールを適用
3. 既存コードのパターンに合わせる

**コード生成の原則**:
- L3 のインターフェース定義に厳密に従う
- エラーコードは foundation.md の体系に従う
- 命名規則は rules.md に従う

### Phase 5: 検証ループ

```
┌─────────────────────────────────────┐
│ テスト実行（Bash）                    │
└─────────────────────────────────────┘
              ↓
    ┌─────────┴─────────┐
    ↓                   ↓
 成功              失敗
    ↓                   ↓
 Phase 6へ      エラー分析
                        ↓
                   修正
                        ↓
                   再実行（最大3回）
                        ↓
                3回失敗 → 中断＋報告
```

**検証ループの原則**:
- 最大反復回数: 3回（circuit-breaker）
- 各反復でエラー内容を分析し、異なるアプローチを試す
- 同じエラーが続く場合は早期中断

### Phase 6: L3 更新

実装完了後、L3 ドキュメントを更新:

1. **タスクチェックリスト**: 完了タスクに `[x]` マーク
2. **実装メモ（7.2 関連コードへのリンク）**: 生成したファイルパスを記載
3. **技術的負債（7.3）**: 暫定対応があれば記録

## 出力形式

### 成功時

```markdown
# gen-code 完了

**機能**: F-20250125-001 [機能名]
**ステータス**: 成功

## 生成ファイル

| 種別 | パス |
|------|------|
| テスト | tests/features/xxx.test.ts |
| 実装 | src/features/xxx.ts |

## テスト結果

✓ 5 passed
✓ All acceptance criteria verified

## L3 更新内容

- タスクチェックリスト: 4/4 完了
- 実装メモ: コードパス追記済み

## 次のステップ

- `/review F-20250125-001` で最終レビュー
- レビュー後、`implemented` に昇格
```

### 失敗時

```markdown
# gen-code 中断

**機能**: F-20250125-001 [機能名]
**ステータス**: 失敗（検証ループ3回到達）

## エラー内容

```
[最後のエラーログ]
```

## 試行した修正

1. [修正1の内容]
2. [修正2の内容]
3. [修正3の内容]

## 推奨アクション

- L3 の仕様を見直す（曖昧な点がないか）
- foundation.md/rules.md との整合性を確認
- 手動でのデバッグを検討
```

## 注意事項

- **reviewed 状態のL3のみ対象**: draft 状態のL3には実行しない（警告を出す）
- **既存コードの上書き確認**: 同名ファイルがある場合は確認する
- **部分成功は認めない**: 全テスト通過が完了条件
- **rules.md 優先**: rules.md の制約とL3が矛盾する場合、rules.md を優先し警告を出す

## 完了後の案内

- 生成ファイル一覧を報告
- テスト結果サマリを報告
- `/review` で最終レビューを案内
- レビュー後の `implemented` 昇格を案内
