# SSDD v1.x → v2.0 マイグレーションガイド

## 概要

SSDD v2.0 では、運用上の問題点を根本的に解決する4つの重要な変更が行われました。本ドキュメントでは、既存プロジェクトを v1.x から v2.0 へ移行する方法を説明します。

## 移行戦略

### 推奨アプローチ: 段階的移行

既存プロジェクトでは、以下の**段階的移行**を推奨します：

1. **既存IDは保持**: v1.x形式のIDをそのまま維持
2. **新規IDはv2.0形式**: 新しく作成するドキュメントのみv2.0形式を使用
3. **テンプレート更新**: 新規作成時にv2.0テンプレートを使用
4. **ドキュメントの段階的更新**: リファクタリングのタイミングで古いドキュメントを更新

この方法により、既存の参照を壊さずに新形式へ移行できます。

### フルリセットアプローチ

小規模プロジェクト、またはドキュメント数が少ない場合は、全ドキュメントを一括更新することも可能です。

---

## 変更点の詳細と移行手順

### 変更1: ID管理方式の変更

#### 変更内容

| 項目 | v1.x | v2.0 |
|------|------|------|
| 形式 | 連番（REQ-0001） | タイムスタンプベース（REQ-20250125-001） |
| 採番方法 | 手動またはカウントアップ | 現在日時＋連番 |
| 衝突リスク | 並行開発時に高い | なし |

#### 移行手順

**段階的移行（推奨）:**

```bash
# 既存IDの例
REQ-0001  # v1.x形式 - そのまま維持
REQ-0002  # v1.x形式 - そのまま維持

# 新規IDの例
REQ-20250125-001  # v2.0形式 - 新規作成時に使用
REQ-20250125-002  # v2.0形式 - 新規作成時に使用
```

**フルリセット（オプション）:**

1. すべてのドキュメントのIDを一覧化
   ```bash
   /check --list-ids > id_mapping.txt
   ```

2. マッピング表を作成
   ```
   REQ-0001 → REQ-20250120-001
   REQ-0002 → REQ-20250120-002
   F-0001 → F-20250120-001
   ```

3. 全ドキュメントの参照を一括置換
   - フロントマターの `id` フィールド
   - `req_ids`, `nfr_ids`, `phase`, `depends_on` の参照

4. 整合性チェック
   ```bash
   /check
   ```

---

### 変更2: フロントマター仕様の変更

#### 変更内容

| 項目 | v1.x | v2.0 |
|------|------|------|
| タイトル管理 | `title` フィールド | Markdown見出し `# タイトル` |
| 問題 | フロントマターと本文の同期 | 単一ソースで管理 |

#### 移行手順

**各ドキュメントで以下を実施:**

1. **v1.x形式（変更前）:**
   ```yaml
   ---
   id: F-0001
   kind: feature
   layer: L3
   title: "ユーザー認証機能"
   status: active
   doc_status: reviewed
   ---

   ## 概要
   ...
   ```

2. **v2.0形式（変更後）:**
   ```yaml
   ---
   id: F-0001
   kind: feature
   layer: L3
   status: active
   doc_status: reviewed
   ---

   # ユーザー認証機能

   ## 概要
   ...
   ```

**変更点:**
- `title:` 行を削除
- フロントマター直後に `# タイトル` を追加

**一括変換スクリプト例:**

```python
import re
from pathlib import Path

def convert_frontmatter(file_path):
    content = file_path.read_text(encoding='utf-8')

    # Extract frontmatter title
    title_match = re.search(r'^title:\s*["\']?([^"\'\n]+)["\']?$', content, re.MULTILINE)
    if not title_match:
        return  # No title field found

    title = title_match.group(1)

    # Remove title field from frontmatter
    content = re.sub(r'^title:.*\n', '', content, flags=re.MULTILINE)

    # Insert markdown heading after frontmatter
    content = re.sub(r'(---\n\n)', f'---\n\n# {title}\n\n', content)

    file_path.write_text(content, encoding='utf-8')

# 全ドキュメントに適用
for md_file in Path('docs').rglob('*.md'):
    if 'templates' in str(md_file):
        continue  # テンプレートはスキップ
    convert_frontmatter(md_file)
```

---

### 変更3: L2構成のシンプル化

#### 変更内容

| 項目 | v1.x | v2.0 |
|------|------|------|
| ファイル構成 | 4ファイル | 2ファイル（デフォルト） |
| overview.md | 用語集・技術方針・アーキテクチャ | 用語集・技術方針・アーキテクチャ・**NFRカタログ** |
| phases.md | フェーズ定義 | フェーズ定義・**機能一覧** |
| nfr.md | 非機能要求カタログ | (**削除** - overview.mdに統合) |
| features_index.md | 機能一覧 | (**削除** - phases.mdに統合) |

#### 移行手順

**v1.x（4ファイル構成）→ v2.0（2ファイル構成）:**

1. **nfr.md の内容を overview.md に統合**

   `docs/l2_system/overview.md` に以下のセクションを追加：
   ```markdown
   ## 7. 非機能要求カタログ

   | NF ID | 名称 | 説明 | カテゴリ | 優先度 | 適用範囲 | テスト方法 |
   |-------|------|------|---------|--------|----------|-----------|
   | NF-0001 | レスポンス性能 | 3秒以内に応答 | 性能 | Must | 全機能 | 負荷テスト |
   ```

2. **features_index.md の内容を phases.md に統合**

   `docs/l2_system/phases.md` の各フェーズセクションに以下を追加：
   ```markdown
   ### 対象機能一覧（記載順＝実装順）

   | 順序 | 機能ID | 機能名 | 概要 |
   |------|--------|--------|------|
   | 1 | F-0001 | [機能名] | [概要] |
   ```

3. **不要ファイルの削除**
   ```bash
   rm docs/l2_system/nfr.md
   rm docs/l2_system/features_index.md
   ```

4. **整合性チェック**
   ```bash
   /check
   ```

**注意**: 4ファイル構成を継続使用することも可能です。v2.0でも4ファイル構成はサポートされていますが、新規プロジェクトでは2ファイル構成を推奨します。

---

### 変更4: 技術選定プロセスの変更

#### 変更内容

| 項目 | v1.x | v2.0 |
|------|------|------|
| 選定方法 | AI自動選定 | AI提案 → 人間選択 |
| プロセス | WebSearch自動実行 | ユーザーとの対話で選定 |
| 問題 | 不適切な技術が選ばれるリスク | 人間が最終判断 |

#### 移行手順

**既存プロジェクト:** 変更不要（技術スタックは既に確定）

**新規L2生成時:**

1. `/gen-l2` コマンドを実行
2. AIが技術候補を提示
3. 対話形式で選択肢から選択
4. 選択結果がL2に記録される

**既存ドキュメントのレビュー:**

既存のL2ドキュメント（`docs/l2_system/overview.md`）の技術選定セクションをレビューし、選定理由が明記されているか確認：

```markdown
### 4.1 クライアント側

| 項目 | 選定技術 | 理由 |
|------|---------|------|
| フレームワーク | React | **理由を明記** |
```

---

## チェックリスト

### 段階的移行チェックリスト

- [ ] **テンプレート更新**: `docs/templates/` を v2.0 版に更新
- [ ] **コマンド更新**: `.claude/commands/` を v2.0 版に更新
- [ ] **スキル更新**: `.claude/skills/ssdd_core.md` 他、モジュール化されたスキルを配置
- [ ] **新規ID方針決定**: 新規ドキュメントでタイムスタンプベースID使用を開始
- [ ] **既存ドキュメントの title フィールド確認**: 段階的に削除
- [ ] **L2構成検討**: 2ファイル構成への移行を検討（オプション）
- [ ] **整合性チェック実行**: `/check` で問題ないか確認
- [ ] **チーム周知**: v2.0変更点をチームに共有

### フルリセットチェックリスト

- [ ] **バックアップ作成**: Git で現在の状態をコミット
- [ ] **ID一覧取得**: `/check --list-ids` でマッピング表作成
- [ ] **ID一括変換**: 全ドキュメントのIDをv2.0形式に変換
- [ ] **title フィールド削除**: 全ドキュメントでフロントマター変換
- [ ] **L2構成変更**: 4ファイル → 2ファイル構成に変更
- [ ] **参照整合性確認**: `/check` でエラーがないか確認
- [ ] **レビュー実行**: `/review` で各ドキュメントをレビュー
- [ ] **動作確認**: 各コマンドが正常に動作するか確認

---

## トラブルシューティング

### Q1: ID変換後に参照エラーが出る

**原因**: `req_ids`, `nfr_ids`, `phase` の参照が古いID形式のまま

**解決方法:**
```bash
/check  # エラー箇所を特定
```

手動で該当箇所を修正：
```yaml
# 修正前
req_ids:
  - REQ-0001

# 修正後
req_ids:
  - REQ-20250120-001
```

### Q2: title フィールド削除後、タイトルが表示されない

**原因**: フロントマター直後にMarkdown見出し `#` がない

**解決方法:**

フロントマター直後に見出しを追加：
```yaml
---
id: F-20250125-001
kind: feature
layer: L3
status: active
doc_status: reviewed
---

# ユーザー認証機能  ← この行を追加
```

### Q3: L2の2ファイル構成への変換が複雑

**原因**: nfr.md と features_index.md の内容が大きい

**解決方法:**

段階的に移行：
1. 一旦4ファイル構成のまま維持
2. 新規フェーズ追加時に phases.md に機能一覧を含める
3. 新規NFR追加時に overview.md に記載
4. 最終的に nfr.md と features_index.md が空になったら削除

### Q4: タイムスタンプベースIDが長すぎる

**原因**: v2.0の仕様（REQ-20250125-001）

**対応方法:**

- **推奨**: v2.0形式をそのまま使用（並行開発の安全性を優先）
- **代替案**: プロジェクト固有の短縮形式を定義（例: `REQ-2501-001`）
  - ただし、衝突リスクが増えるため非推奨

---

## 移行タイムライン例

### 小規模プロジェクト（~10ドキュメント）

| Week | タスク |
|------|--------|
| Week 1 | テンプレート・コマンド更新、ID一括変換、title変換 |
| Week 2 | L2構成変更、整合性チェック、レビュー |

**所要時間**: 2週間

### 中規模プロジェクト（10-50ドキュメント）

| Week | タスク |
|------|--------|
| Week 1 | テンプレート・コマンド更新、新規ID方針決定 |
| Week 2-4 | 段階的にtitle変換、新規ドキュメントはv2.0形式 |
| Week 5 | L2構成変更検討、整合性チェック |

**所要時間**: 5週間

### 大規模プロジェクト（50+ドキュメント）

| Phase | タスク |
|-------|--------|
| Phase 1 (Month 1) | テンプレート更新、新規はv2.0形式のみ |
| Phase 2 (Month 2-3) | アクティブなドキュメントから段階的に変換 |
| Phase 3 (Month 4) | 全体の整合性チェックとレビュー |

**所要時間**: 4ヶ月

---

## v2.0のメリット

移行によって得られる主なメリット：

1. **ID衝突の防止**: 並行開発時のID重複が根本的に解消
2. **ドキュメント保守性向上**: title同期問題の解消
3. **小規模プロジェクトの使いやすさ向上**: L2の2ファイル構成
4. **技術判断の品質向上**: 人間主導の技術選定

---

## 参考資料

- [SSDD v2.0 変更点まとめ](README.md#バージョン情報)
- [フロントマター仕様](templates/README.md)
- [開発フロー・チェックリスト](checklists.md)
- [SSDD ガイド](guide.md)

---

**更新日**: 2025-01
**対象バージョン**: SSDD v1.x → v2.0
