# Claude Code プラグイン開発 原則・推奨事項ガイド

このドキュメントは、Tri-SSD Claude Code プラグイン開発における原則と推奨事項を定義します。

---

## 1. 基本原則

### 1.1 ファイルサイズ制限

| 対象 | 推奨 | 最大 | 理由 |
|------|------|------|------|
| コマンド定義 | 200-400行 | 800行 | コンテキストウィンドウの効率的利用 |
| スキル定義 | 300-500行 | 1000行 | 複雑なオーケストレーションを許容 |
| CLAUDE.md | 150-200指示 | 300指示 | 認知負荷の軽減 |

**大きくなりすぎた場合:**
- 複数コマンドに分割
- 共通部分を別ファイルに抽出
- `.claude/rules/` でコンテキスト依存ルールに移動

### 1.2 単一責任原則

```
1コマンド = 1つの明確な責任
```

**良い例:**
- `/trissd-l1` - L1ビジョンドキュメントの生成
- `/trissd-l2-foundation` - L2技術基盤の生成
- `/trissd-l3` - L3機能仕様の生成

**避けるべき例:**
- `/trissd-all` - 全レイヤーを一度に生成（責任が広すぎる）

### 1.3 段階的開示（Progressive Disclosure）

ユーザーに情報を段階的に提示する:

1. **基本機能を先に**: 必須操作を最初に案内
2. **詳細は後から**: オプション機能は必要時に説明
3. **デフォルトを賢く**: 80%のケースをカバーする初期値

---

## 2. コマンド設計パターン

### 2.1 必須構造

すべてのコマンドは以下の構造を持つ:

```markdown
---
description: コマンドの説明（1行）
argument-hint: "[引数] - 説明"
allowed-tools: Read, Write, Edit, Glob, Grep
---

# コマンド名

<tri_ssd_context>
（Tri-SSDコンテキストブロック）
</tri_ssd_context>

<avoid_over_engineering>
（過剰設計回避の指示）
</avoid_over_engineering>

## 目的
## 入力
## 出力フォーマット
## 処理手順
## 完了後の案内
```

### 2.2 コンテキストブロックの役割

#### `<tri_ssd_context>`
- Tri-SSD三層モデルの説明
- レイヤー構造とファイル配置
- ID形式とステータス遷移

#### `<avoid_over_engineering>`
- 過剰な詳細化の抑制
- 「わからない」→ TODOマークの推奨
- 「念のため」追加の禁止

### 2.3 出力フォーマット定義

必ず以下を明記する:

| 項目 | 説明 |
|------|------|
| YAMLフロントマター | 必須フィールドと形式 |
| Markdownテンプレート | 必須セクション構造 |
| 省略可能セクション | 不要時にスキップ可能な部分 |

---

## 3. スキル設計パターン

### 3.1 必須構造

```markdown
---
name: スキル名
description: >
  スキルの説明。
  トリガーワードを含める。
---

# スキル名

## Instructions
（動作手順）

## 利用可能なコマンド
（コマンド一覧）

## Examples
（使用例）

## Limitations
（制限事項）
```

### 3.2 トリガーワードの重要性

descriptionには以下を含める:
- スキルが起動する条件
- ユーザーが使用するキーワード
- 典型的なユースケース

---

## 4. Tri-SSD 三層モデルとの整合性

### 4.1 レイヤースキップの禁止

```
L1 → L2 → L3 の順序を必ず守る
```

| 禁止パターン | 理由 |
|-------------|------|
| L1なしでL2を生成 | ビジョンなき技術設計 |
| L2なしでL3を生成 | 基盤なき機能仕様 |
| draft状態のL3からコード生成 | 未承認仕様の実装 |

### 4.2 ドキュメントステータスの尊重

```
doc_status: draft → reviewed → implemented
```

- `draft`: 生成直後、変更可能
- `reviewed`: 承認済み、実装可能
- `implemented`: 実装完了、変更は慎重に

### 4.3 ID形式の遵守

```
PREFIX-YYYYMMDD-nnn
```

| プレフィックス | 用途 |
|---------------|------|
| VISION | L1ビジョン |
| REQ | 要件 |
| NF | 非機能要求 |
| PH | フェーズ |
| F | 機能 |

---

## 5. コンテキスト効率

### 5.1 大きなファイルの扱い

**避けるべき:**
- 全ファイルを一度に読み込む
- 不要な部分まで含める
- 同じ情報を複数箇所で重複

**推奨:**
- 必要な部分のみ参照
- Grepで該当行を特定
- 共通情報は一箇所で定義

### 5.2 CLAUDE.mdの最適化

- 指示は150-200を目安に
- 詳細は参照ドキュメントへ
- コンテキスト依存ルールを活用

---

## 6. エラー処理とフィードバック

### 6.1 エラーメッセージ

**良い例:**
```
❌ L2ドキュメントが見つかりません。
   先に /trissd-l2 を実行してください。
```

**避けるべき例:**
```
エラーが発生しました。
```

### 6.2 進捗フィードバック

処理中は以下を報告:
- 現在のステップ
- 完了した項目
- 次のアクション

---

## 7. テスト戦略

### 7.1 TDDの推奨

1. テストを先に書く
2. 失敗を確認
3. 実装
4. テスト通過を確認
5. リファクタリング

### 7.2 カバレッジ目標

| 対象 | 目標 |
|------|------|
| コアロジック | 80%以上 |
| エラーハンドリング | 90%以上 |
| エッジケース | 網羅的に |

---

## 8. アンチパターン

### 8.1 一般的なアンチパターン

| パターン | 問題 | 解決策 |
|---------|------|--------|
| 巨大コマンド | コンテキスト超過 | 分割 |
| 曖昧な説明 | 誤った起動 | 具体的なトリガーワード |
| ハードコード | 柔軟性欠如 | 設定の外部化 |

### 8.2 Tri-SSD固有のアンチパターン

| パターン | 問題 | 解決策 |
|---------|------|--------|
| レイヤースキップ | 整合性崩壊 | 順序遵守 |
| ID重複 | トレーサビリティ喪失 | 採番ロジック徹底 |
| ステータス無視 | 未承認実装 | draft/reviewed確認 |

---

## 9. チェックリスト

### コマンド作成時

- [ ] フロントマターに必須フィールドがある
- [ ] `<tri_ssd_context>` ブロックがある
- [ ] `<avoid_over_engineering>` ブロックがある
- [ ] 出力フォーマットが明確に定義されている
- [ ] 完了後の案内がある
- [ ] ファイルサイズが800行以下

### スキル作成時

- [ ] フロントマターにname, descriptionがある
- [ ] descriptionにトリガーワードがある
- [ ] Instructionsセクションがある
- [ ] 利用可能なコマンド一覧がある
- [ ] レイヤースキップ禁止が明記されている

### リリース前

- [ ] 全コマンドが単一責任を持つ
- [ ] テストカバレッジが目標を満たす
- [ ] エラーメッセージが明確
- [ ] ドキュメントが最新

---

## 10. 参考資料

| リソース | 内容 |
|---------|------|
| `CLAUDE.md` | プロジェクト概要と基本ルール |
| `docs/frontmatter_spec.md` | フロントマター仕様 |
| `docs/guide.md` | Tri-SSD概念ガイド |
| `templates/` | L1/L2/L3テンプレート |

---

*最終更新: 2026-01-23*
